<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Sales Summary</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <style>
        table.dataTable tbody tr.child {
            background-color: #f9f9f9;
            display: none;
        }
        .child-row {
            background-color: #e6f7ff;
        }
        .child-row td {
            padding-left: 20px;  /* Adjust padding to make it look like a nested table */
        }
    </style>
</head>
<body>
    <h1>Platform Sales Summary</h1>
    <table id="example" class="display">
        <thead>
            <tr>
                <th>平台</th>
                <th>总销量</th>
                <th>总销售额</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be dynamically loaded here -->
        </tbody>
    </table>

    <script>
        $(document).ready(function() {
            // GitHub raw file URL
            const githubFileUrl = 'https://raw.githubusercontent.com/youyi666/youyi666.github.io/refs/heads/main/%E9%94%80%E9%87%8F%E8%A1%A82.csv';

            // Function to get CSV file content from GitHub
            function getGitHubFileContent(fileUrl) {
                return fetch(fileUrl)
                    .then(response => response.text())
                    .then(csvData => {
                        console.log("CSV Data Loaded: ", csvData);  // Log the CSV data to check
                        return csvData;
                    })
                    .catch(error => {
                        console.error("Error fetching CSV: ", error);
                    });
            }

            // Function to parse CSV and load into DataTable
            function loadCSVData(csvData) {
                const rows = csvData.split('\n').map(row => row.split(','));
                const tableData = rows.slice(1).map(row => [
                    row[0].trim(),  // Platform
                    row[1].trim(),  // Model
                    parseInt(row[2].trim()),  // Quantity
                    parseInt(row[3].trim())   // Amount
                ]);
                return tableData;
            }

            // Fetch and process data from GitHub CSV file
            getGitHubFileContent(githubFileUrl).then(csvData => {
                const tableData = loadCSVData(csvData);
                
                // Group data by platform
                const platformSummary = [];
                tableData.forEach(item => {
                    const platform = item[0]; // Platform column (first column)
                    if (!platformSummary[platform]) {
                        platformSummary[platform] = { platform, totalQuantity: 0, totalAmount: 0, details: [] };
                    }
                    platformSummary[platform].totalQuantity += item[2]; // Quantity (third column)
                    platformSummary[platform].totalAmount += item[3]; // Amount (fourth column)
                    platformSummary[platform].details.push(item);
                });

                // Populate the table with platform summary
                const summaryData = [];
                Object.keys(platformSummary).forEach(platform => {
                    const data = platformSummary[platform];
                    summaryData.push([data.platform, data.totalQuantity, data.totalAmount, data.platform]);
                });

                // Append platform summary to the table
                summaryData.forEach(row => {
                    $('#example tbody').append(`
                        <tr class="platform-row">
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                        </tr>
                    `);
                });

                // Initialize DataTable with row grouping by platform
                var table = $('#example').DataTable({
                    "dom": 'Bfrtip',
                    "buttons": [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ],
                    "order": [[0, 'asc']],  // Sort by platform
                    "columnDefs": [
                        {
                            "targets": 0,  // Platform column
                            "visible": true
                        }
                    ]
                });

                // Add drill down functionality
                $('#example tbody').on('click', '.platform-row', function () {
                    var tr = $(this);
                    var row = table.row(tr);

                    // Get the platform name
                    const platformName = tr.children('td').eq(0).text();

                    // Filter the data to show models of the clicked platform
                    const childData = platformSummary[platformName].details;
                    let childHtml = '<table class="child-row"><thead><tr><th>型号</th><th>销量</th><th>销售额</th></tr></thead><tbody>';
                    childData.forEach(d => {
                        childHtml += `<tr><td>${d[1]}</td><td>${d[2]}</td><td>${d[3]}</td></tr>`;
                    });
                    childHtml += '</tbody></table>';

                    // If the row is already expanded, hide it; otherwise, show it
                    if (row.child.isShown()) {
                        row.child.hide();
                        tr.removeClass('shown');
                    } else {
                        row.child(childHtml).show();
                        tr.addClass('shown');
                    }
                });
            }).catch(error => {
                console.error("Error fetching file from GitHub: ", error);
            });
        });
    </script>
</body>
</html>
